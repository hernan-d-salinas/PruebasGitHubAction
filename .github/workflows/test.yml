name: Autograde Labs

on:
  pull_request:
    paths:
      - "estudiantes/**/lab*.ipynb"
      - "autograde/**"
      - ".github/workflows/autograde.yml"

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set_matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set_matrix
        name: Build matrix from changed notebooks
        shell: bash
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep -E '^estudiantes/.+/lab[0-9]+\.ipynb$' || true)
          echo "CHANGED<<EOF" >> $GITHUB_ENV
          echo "$CHANGED" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          python - << 'PY' >> $GITHUB_OUTPUT
import json, os, re
changed = os.environ.get("CHANGED", "").strip().splitlines()
items = []
for p in changed:
    m = re.search(r"(lab\d+)\.ipynb$", p)
    if not m:
        continue
    lab = m.group(1)
    items.append({"lab": lab, "path": p})

print("matrix=" + json.dumps({"include": items}))
PY

  grade:
    needs: detect
    if: ${{ fromJson(needs.detect.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install nbformat

      - name: Run autograder
        run: |
          python autograde/grade.py --lab ${{ matrix.lab }} --paths "${{ matrix.path }}" --out grades_${{ matrix.lab }}.json

      - name: Comment results on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const f = `grades_${{ matrix.lab }}.json`;
            let body = `## ðŸ§ª Autograde ${{ matrix.lab }}\n`;
            if (!fs.existsSync(f)) {
              body += "\nNo pude generar el JSON de calificaciÃ³n.\n";
            } else {
              const g = JSON.parse(fs.readFileSync(f,'utf8'));
              for (const r of g.results) {
                body += `\n### ${r.student}\n- File: \`${r.path}\`\n- Status: **${r.status}**\n`;
                if (r.errors?.length) body += `- Errors:\n` + r.errors.map(e=>`  - ${e}`).join("\n") + "\n";
                if (r.warnings?.length) body += `- Warnings:\n` + r.warnings.map(w=>`  - ${w}`).join("\n") + "\n";
              }
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grades-${{ matrix.lab }}
          path: grades_${{ matrix.lab }}.json
