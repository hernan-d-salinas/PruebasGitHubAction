name: Autograde Labs

on:
  pull_request:
    paths:
      - "estudiantes/**/lab*.ipynb"
      - "autograde/**"
      - ".github/workflows/autograde.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  autograde:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install nbformat

      - name: Run autograder on changed notebooks
        shell: bash
        run: |
          set -e

          # notebooks changed in this PR
          CHANGED=$(git diff --name-only FETCH_HEAD...${{ github.sha }} | grep -E '^estudiantes/.+/lab[0-9]+\.ipynb$' || true)

          # always create a grades file (even if empty)
          echo '{"results":[]}' > grades_all.json

          if [ -z "$CHANGED" ]; then
            echo "No changed notebooks detected."
            exit 0
          fi

          echo "$CHANGED" > changed.txt
          FAIL=0

          while IFS= read -r nb; do
            [ -z "$nb" ] && continue
            lab=$(basename "$nb" .ipynb)   # lab01, lab02, ...

            echo "Grading: $nb (lab=$lab)"
            python autograde/grade.py --lab "$lab" --paths "$nb" --out grade_one.json || FAIL=1

            python -c "import json; a=json.load(open('grades_all.json','r',encoding='utf-8')); o=json.load(open('grade_one.json','r',encoding='utf-8')); a['results'].extend(o.get('results',[])); json.dump(a, open('grades_all.json','w',encoding='utf-8'), indent=2, ensure_ascii=False)"
          done < changed.txt

          exit $FAIL

      - name: Comment results on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            let body = "## ðŸ§ª Autograde\n";

            if (!fs.existsSync("grades_all.json")) {
              body += "\nNo se generÃ³ `grades_all.json`.\n";
            } else {
              const g = JSON.parse(fs.readFileSync("grades_all.json", "utf8"));
              if (!g.results.length) {
                body += "\nNo hubo notebooks evaluados (PR no cambiÃ³ `estudiantes/**/labXX.ipynb`).\n";
              } else {
                for (const r of g.results) {
                  body += `\n### ${r.student} â€” ${r.lab}\n- File: \`${r.path}\`\n- Status: **${r.status}**\n`;
                  if (r.errors?.length) body += `- Errors:\n` + r.errors.map(e=>`  - ${e}`).join("\n") + "\n";
                  if (r.warnings?.length) body += `- Warnings:\n` + r.warnings.map(w=>`  - ${w}`).join("\n") + "\n";
                }
              }
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grades
          path: grades_all.json
